<% days = ["日", "月", "火", "水", "木", "金", "土"] %>
<div data-scope-path="shared/header">
  <h1>日報</h1>
  <%= render "shared/header" %>
</div>
<div style="display:flex;">
  <div data-scope-path="shared/side_bar">
    <%= render "shared/sidebar" %>
  </div>
    <div data-scope-path="results/daily_report">
        <h2>
          <%= link_to "<<",daily_report_results_path(month:@month.ago(1.days),base_category: @base_category), class:"link" %>
          <%= @base_category %>
          <%= @month.month %>月
          <%= @month.day %>日（<%= days[@month.wday] %>）
          集計期間：<%= @results.minimum(:date) %>〜<%= @results.maximum(:date) %>
          <%= link_to ">>",daily_report_results_path(month:@month.since(1.days),base_category: @base_category), class:"link" %>
        </h2>
        
        <div class="separate"><%# 左右に分ける %>
        <div class="left-form">
        <h3 class="sub-title">◆本日稼働結果</h3>
          <% date = "#{@month.month}月#{@month.day}日" %>
          <% team_shift = "新規#{@shifts.where(shift: "キャッシュレス新規").length}　決済#{@shifts.where(shift: "キャッシュレス決済").length}" %>
          <% team_get = "dメル#{@results.sum(:dmer)}　楽天ペイ#{@results.sum(:rakuten_pay)}AirPay#{@results.sum(:airpay)}" %>
          <textarea>
            <%= date %>
            チームAve：<%= (@results.sum(:profit).to_f / @shift_digestion.length).round().to_s(:delimited) rescue 0 %>
            チームシフト：<%= team_shift %>
            チーム売上：<%= @results.sum(:profit).to_s(:delimited) rescue 0 %>
            チームdメルAve：<%= (@results.sum(:dmer).to_f / @shift_digestion.length).round(1) rescue 0 %>
            チーム獲得本数：<%= team_get %>
          <% @users.each do |user| %>
          <% shift = "新規#{@shifts.where(user_id: user.id).where(shift: "キャッシュレス新規").length}　決済#{@shifts.where(user_id: user.id).where(shift: "キャッシュレス決済").length}" %>
          <% 
            date_progress = 
              "#{@result.where(user_id: user.id).sum(:first_total_visit) + @result.where(user_id: user.id).sum(:latter_total_visit)}-#{@result.where(user_id: user.id).sum(:first_visit) + @result.where(user_id: user.id).sum(:latter_visit)}-#{@result.where(user_id: user.id).sum(:first_interview) + @result.where(user_id: user.id).sum(:latter_interview)}-#{@result.where(user_id: user.id).sum(:first_full_talk) + @result.where(user_id: user.id).sum(:latter_full_talk)}-#{@result.where(user_id: user.id).sum(:first_get) + @result.where(user_id: user.id).sum(:latter_get)}" 
          %>
            ◆<%= user.name %>
            dメルAve：<%= @results.where(user_id: user.id).sum(:dmer) / @shift_digestion.where(user_id: user.id).length rescue 0 %>
            楽天Ave：<%= @results.where(user_id: user.id).sum(:rakuten_pay) / @shift_digestion.where(user_id: user.id).length rescue 0 %>
            Air獲得：<%= @results.where(user_id: user.id).sum(:airpay) rescue 0 %>
            現状Ave：<%= (@results.where(user_id: user.id).sum(:profit) / @shift_digestion.where(user_id: user.id).length).round().to_s(:delimited) rescue 0 %>
            現状売上：<%= @results.where(user_id: user.id).sum(:profit).to_s(:delimited) rescue 0 %>
            当日売上：<%= @result.where(user_id: user.id).sum(:profit).to_s(:delimited) rescue 0 %>
            シフト：<%= shift %>
            基準値：<%= date_progress %>
          <% end %>

          </textarea>
        </div>
        <div class="right-form">
        <h3 class="sub-title">◆本日稼働予定者</h3>
          <% if @shift.length == 0 %>
          <p>本日稼働予定者はいません。
          <% else %>
          <% @shift.each do |s| %>
            <p class="conf-text">
            <% if (@result.find_by(user_id: s.user_id).present?) && (@result.find_by(user_id: s.user_id).shift != s.shift) %>
              <span class="red">予定<%= s.shift.slice(-2,2) %></span> 
            <% else %>
              <span class="">予定<%= s.shift.slice(-2,2) %></span> 
            <% end %>
              / 終着<%= @result.find_by(user_id: s.user_id).shift.slice(-2,2) rescue "未入力" %>：
              <%= s.user.name %>
              <% if @result.exists?(user_id: s.user_id) %>
              <span>終着入力済：<%= link_to "終着修正",edit_result_path(@result.find_by(user_id: s.user_id).id), class: "link" %> </span>
              <% else %>
              <span class="red"><%= link_to "終着未入力：終着入力",new_result_path(user_id: s.user_id,date: @month), class: "red-link" %></span>
              <% end %>
              
                <% if (@result.find_by(user_id: s.user_id)) && (s.shift != @result.find_by(user_id: s.user_id).shift) %>
                <span class="red">※<%= link_to "予定シフト相違（変更）",edit_shift_path( s.id), class: "red-link" %></span>
                <% end %>
            
          <% end %>
          <% end %>
        </div>
        </div><%# 左右に分ける %>

    </div>
</div>