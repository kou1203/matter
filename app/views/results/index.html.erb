<% days = ["日", "月", "火", "水", "木", "金", "土"] %>
<div data-scope-path="shared/header">
  <h1>利益表SS</h1>
  <%= render "shared/header" %>
</div>
  <div style="display:flex;">
  <div data-scope-path="shared/side_bar">
    <%= render "shared/sidebar" %>
  </div>
  <div class="main">
    <div data-scope-path="results/index">
      <%# 検索フォーム %>
      <p class="nav-text">こちらから確認したい情報を絞り込んでください</p>
      <%= search_form_for @q do |f| %>
        <table >
          <tr>
            <th class="search-th" colspan="">獲得月</th>
            <th class="search-th">拠点</th>
            <td class="result"><%= f.submit "絞込み",data: {"turbolinks" => false, disable_with: "絞込み中"} , class: "result-btn" %></td>
          </tr>
          <tr>
            <td class="search-td"><%= f.date_select :date_during_month, {discard_day: true,prompt: "--"},{class: "date-input"} %></td>
            <td class="search-td"><%= f.select :user_base_eq, options_from_collection_for_select(User.where.not(base: "中部N").where.not(base: "関西N").where.not(position: "退職").select(:base).distinct, :base, :base), {prompt: "全拠点"},{class: "input"} %></td>
            <td class="reset"><%= link_to "絞込みリセット", results_path, class: "reset-link" %></td>
          </tr>
        </table>
      <% end %>
      <%# /検索フォーム %>
      <hr>
      <% if @results.empty? %>
      <% if current_user.position == "権限①" %>
        <h2>利益表（基準値）インポート</h2>
        <%= form_with url: import_results_path do |f| %>
          <table class="csv-tb">
            <tr>
              <td class=""><%= f.file_field :file, accept: ".csv", class: "input" %></td>
              <td class="result"><%= f.submit  "インポート", class: "result-btn",data: { confirm: 'インポートしますか？',disable_with: "インポート中" } %></td>
            </tr>
          </table>
        <% end %>
        <h2>利益表（切り返し）インポート</h2>
        <%= form_with url: import_result_cashes_path do |f| %>
          <table class="csv-tb">
            <tr>
              <td class=""><%= f.file_field :file, accept: ".csv", class: "input" %></td>
              <td class="result"><%= f.submit  "インポート", class: "result-btn",data: { confirm: 'インポートしますか？',disable_with: "インポート中" } %></td>
            </tr>
          </table>
        <% end %>

      <% end %>
      <div class="nav-text"><%= alert %></div>
      <% else %>
        <% if @results.group(:user_id).length == 1 %>
          <%= render "result_parts/profit_table_copiedata" %>
        <% else %>
          <%= render "result_parts/all_profit" %>
        <% end %>
      <% end %>
      <h2><%= link_to "<<",results_path(month:@month_daily.prev_week), class:"link" %>
          <%= @month_daily.month %>月
          <% if @month_daily.present? %>
          <%= @month_daily %>〜
          <%= @month_daily.since(6.days).day %>
          獲得
          <% end %>
          <%= link_to ">>",results_path(month:@month_daily.next_week), class:"link" %>
      </h2>
        <table class="out-tb">
        <thead>
          <tr>
          <th>ユーザー名</th>
          <th>内容</th>
          <% @results_week.group(:date).each do |r_date| %>
          <th class="out-th"><%= r_date.date.month %>月<%= r_date.date.day %>日</th>
          <% end %>
            </tr>
          </thead>
          <tbody>
          <tr>
          <% @results_week.group(:user_id).each do |r_user| %>
            <th class="out-th" rowspan="2"><%= r_user.user.name %></th>
            <td>営業終着内訳</td>
            <% @results_week.group(:date).each do |r_date| %>
            <% dmer_len = @dmers.where(date: r_date.date).where(user_id: r_user.user.id).length %>
            <% aupay_len = @aupays.where(date: r_date.date).where(user_id: r_user.user.id).length %>
            <% paypay_len = @paypays.where(date: r_date.date).where(user_id: r_user.user.id).length %>
            <% rakuten_pay_len = @rakuten_pays.where(date: r_date.date).where(user_id: r_user.user.id).length %>
              <td>
              <% if @results_week.where(user_id: r_user.user_id).exists?(date: r_date.date) %>
              <% if @results_week.where(user_id: r_user.user_id).where.not(result_cash: {dmer: nil}).exists?(date: r_date.date)  %>
              <% if dmer_len != @results_week.where(user_id: r_user.user_id).where(date: r_date.date).first.result_cash.dmer %>
              <span style="color:red;">dメル</span>
              <% else %>
              <span >dメル</span>
              <% end %>
              <%= @results_week.where(user_id: r_user.user_id).where(date: r_date.date).first.result_cash.dmer %>
              <% end %>
              
              <% if @results_week.where(user_id: r_user.user_id).where.not(result_cash: {aupay: nil}).exists?(date: r_date.date)  %>
              <% if aupay_len != @results_week.where(user_id: r_user.user_id).where(date: r_date.date).first.result_cash.aupay %>
              <span style="color:red;">auPay</span>
              <% else %>
              <span >auPay</span>
              <% end %>
              <%= @results_week.where(user_id: r_user.user_id).where(date: r_date.date).first.result_cash.aupay %>
              <% end %>
              <% if @results_week.where(user_id: r_user.user_id).where.not(result_cash: {paypay: nil}).exists?(date: r_date.date)  %>
              <% if paypay_len != @results_week.where(user_id: r_user.user_id).where(date: r_date.date).first.result_cash.paypay %>
              <span style="color:red;">PayPay</span>
              <% else %>
              <span >PayPay</span>
              <% end %>
              <%= @results_week.where(user_id: r_user.user_id).where(date: r_date.date).first.result_cash.paypay %>
              <% end %>
              <% if @results_week.where(user_id: r_user.user_id).where.not(result_cash: {rakuten_pay: nil}).exists?(date: r_date.date)  %>
              <% if rakuten_pay_len != @results_week.where(user_id: r_user.user_id).where(date: r_date.date).first.result_cash.rakuten_pay %>
              <span style="color:red;">楽天ペイ</span>
              <% else %>
              <span >楽天ペイ</span>
              <% end %>
              <%= @results_week.where(user_id: r_user.user_id).where(date: r_date.date).first.result_cash.rakuten_pay %>
              <% end %>
             </td>
            <% end %>
          <% end %>
          </tr>
          <tr>
          <td style="opacity:0.5;">管理登録内訳</td>
            <% @results_week.group(:date).each do |r_date| %>
            <% product_sum = 0 %>
            <% dmer_len = @dmers.where(date: r_date.date).where(user_id: r_user.user.id).length %>
            <% aupay_len = @aupays.where(date: r_date.date).where(user_id: r_user.user.id).length %>
            <% paypay_len = @paypays.where(date: r_date.date).where(user_id: r_user.user.id).length %>
            <% rakuten_pay_len = @rakuten_pays.where(date: r_date.date).where(user_id: r_user.user.id).length %>
            <td style="opacity: 0.5;">
            <% if dmer_len != 0 %>
              dメル
              <%= dmer_len %>
            <% end %>
            <% if aupay_len != 0 %>
              auPay
              <%=  aupay_len %>
            <% end %>
            <% if paypay_len != 0 %>
              PayPay
              <%= paypay_len %>
            <% end %>
            <% if rakuten_pay_len != 0 %>
              楽天ペイ
              <%=  rakuten_pay_len %>
            <% end %>
            </td>
            <% end %>
          </tr>
        <% end %>
        </tbody>
        </table>
      <h2>キャッシュレス</h2>
      <% users_data = [@users_chubu_cash, @users_kansai_cash, @users_kanto_cash] %>
      <div class="user-form">
        <div>
        <table class="user-tb">
      <% users_data.each do |users| %>
        <tr>
          <th><%= users.first.base %></th>
        <% users.each do |user| %>
          <td><%= link_to user.name, user_path(user.id), class: "link" %></td>
        <% end %>
        </tr>
      <% end %>
        </table>
        </div>
      </div>
    </div>
  </div>
</div>