<% days = ["日", "月", "火", "水", "木", "金", "土"] %>
<div data-scope-path="shared/header">
  <h1>ランキング</h1>
  <%= render "shared/header" %>
</div>
<div style="display:flex;">
  <div data-scope-path="shared/side_bar">
    <%= render "shared/sidebar" %>
  </div>
  <div class="main">
    <div data-scope-path="results/ranking">
<% ranking = {} %>
<% ranking_ave = {} %>
<%# 各商材の%を選択 %>
<h2>
  <%= link_to "<<",ranking_results_path(month:@month.prev_month), class:"link" %>
  <%= @month.month %>月 (<%= @minimum_date_cash.strftime("%m月%d日") %>〜<%= @maximum_date_cash.strftime("%m月%d日") %>)
  <%= link_to ">>",ranking_results_path(month:@month.next_month), class:"link" %>
</h2>
<% max_date = @month.beginning_of_month.since(24.days) %>
<% if @results.present? %>
<% if (Date.today > max_date) && (Date.today.month == max_date.month) %>
  <% dec_per = (Date.today.day - max_date.day).to_i * 0.1 %>
<% else %>   
  <% dec_per = 0 %>
<% end %>
<% dmer_result1_per = 0.64 %>
<% dmer_result2_per = 0.58 %>
<% dmer_result3_per = 0.52 %>
<% dmer_result1_per_prev = 0.9 %>
<% dmer_result2_per_prev = 0.9 %>
<% dmer_result2_per_prev = 1 %>
<% aupay_slmt_per = 0.75 %>
<% aupay_slmt_per_prev = 0.71 %>
<%# dメル %>
<% if dec_per > dmer_result1_per %>
  <% dmer_result1_per = 0 %>
<% else %>
  <% dmer_result1_per = dmer_result1_per - dec_per %>
<% end %>

<% if dec_per > dmer_result2_per %>
  <% dmer_result2_per = 0 %>
<% else %>
  <% dmer_result2_per = dmer_result2_per - dec_per %>
<% end %>

<% if dec_per > dmer_result3_per %>
  <% dmer_result3_per = 0 %>
<% else %>
  <% dmer_result3_per = dmer_result3_per - dec_per %>
<% end %>

<% if dec_per > dmer_result1_per_prev %>
  <% dmer_result1_per_prev = 0 %>
<% else %>
  <% dmer_result1_per_prev = dmer_result1_per_prev - dec_per %>
<% end %>

<% if dec_per > dmer_result2_per_prev %>
  <% dmer_result2_per_prev = 0 %>
<% else %>
  <% dmer_result2_per_prev = dmer_result2_per_prev - dec_per %>
<% end %>
<%# auPay %>
<% if dec_per > aupay_slmt_per %>
  <% aupay_slmt_per = 0 %>
<% else %>
  <% aupay_slmt_per = aupay_slmt_per - dec_per %>
<% end %>

<% if dec_per > aupay_slmt_per_prev %>
  <% aupay_slmt_per_prev = 0 %>
<% else %>
  <% aupay_slmt_per_prev = aupay_slmt_per_prev - dec_per %>
<% end %>

<%# 単価 %>
<% dmer_price_1 = 8000 %>
<% dmer_price_2 = 4000 %>
<% dmer_price_3 = 5000 %>
<% aupay_price = 8000 %>
<% paypay_price = 1000 %>
<% rakuten_pay_price = 4000 %>
    <% if @cash_result.empty? %>
    <p class="caution-text">指定した日付には終着がありません。</p>
    <% else %>
    <%# 合計値 %>
      <% base_shift = 0 %>
      <% base_new_shift = 0 %>
      <% base_slmt_shift = 0 %>
      <% 
        base_shift_digestion = 
          @cash_result.where.not(shift: "休み")
          .where.not(shift: "内勤")
          .where.not(shift: "帯同")
          .where.not(shift: "欠勤").length  
      %>
      <% 
        base_new_shift_digestion = 
        @cash_result.where(shift: "キャッシュレス新規")
        .or(
          @cash_result.where(shift: "フェムト新規")
        )
        .or(
          @cash_result.where(shift: "サミット")
        ).length  
      %>
      <% 
        base_slmt_shift_digestion = 
          @cash_result.where(shift: "キャッシュレス決済").length  
      %>
      <%# 拠点評価売上 %>
      <% base_ave = 0 %>
      <% base_fin = 0 %>
      <% base_sum = 0 %>
      <%# 拠点獲得数 %>
      <% base_sum_product = 0 %>
      <% base_dmer = 0 %>
      <% base_dmer_ave = 0 %>
      <% base_dmer_fin = 0 %>
      <% base_dmer_slmt = 0 %>
      <% base_dmer_slmt2nd = 0 %>
      <% base_aupay = 0 %>
      <%# 拠点成果件数 %>
      <% base_dmer_result1_len = 0 %>
      <% base_dmer_result2_len = 0 %>
      <% base_dmer_result3_len = 0 %>
      <% base_aupay_result1_len = 0 %>
      <% base_paypay_result1_len = 0 %>
      <% base_airpay_result1_len = 0 %>

      <% base_aupay_ave = 0 %>
      <% base_aupay_fin = 0 %>
      <% base_aupay_slmt = 0 %>
      <% base_paypay = 0 %>
      <% base_paypay_ave = 0 %>
      <% base_paypay_fin = 0 %>
      <% base_rakuten_pay = 0 %>
      <% base_rakuten_pay_ave = 0 %>
      <% base_rakuten_pay_fin = 0 %>
      <% base_airpay = 0 %>
      <% base_airpay_ave = 0 %>
      <% base_airpay_fin = 0 %>
      <% base_st_insurace = 0 %>
    <% @cash_result.group(:user_id).each do |r| %>
    <%# 変数 %>
      <% r_user = @cash_result.where(user_id: r.user.id) %>
      <%# シフト %>
        <% 
          new_shift = 
          Shift.where(start_time: @minimum_date_cash..@maximum_date_cash).where(user_id: r.user_id).where(shift: "キャッシュレス新規")
          .or(
            Shift.where(start_time: @minimum_date_cash..@maximum_date_cash).where(user_id: r.user_id).where(shift: "フェムト新規")
            )
          .or(
            Shift.where(start_time: @minimum_date_cash..@maximum_date_cash).where(user_id: r.user_id).where(shift: "サミット")
            ).length
        %>
        <% slmt_shift = Shift.where(start_time: @minimum_date_cash..@maximum_date_cash).where(user_id: r.user_id).where(shift: "キャッシュレス決済").length %>
        <% base_slmt_shift += slmt_shift %>
        <%
          shifts = Shift.where(user_id: r.user_id)
          .where(start_time: @minimum_date_cash..@maximum_date_cash)
          .where.not(shift: "休み")
          .where.not(shift: "内勤")
          .where.not(shift: "帯同")
          .where.not(shift: "欠勤").length
        %>
        <% shift_data = Shift.where(user_id: r.user_id)
          .where(start_time: @minimum_date_cash..@maximum_date_cash)
          .where.not(shift: "休み")
          .where.not(shift: "内勤")
          .where.not(shift: "帯同")
          .where.not(shift: "欠勤") %>
        <% base_new_shift += new_shift %>
        <% base_shift += shifts %><%# 予定シフトの合計を取得 %>
        <% 
          shift_digestion = r_user
          .where.not(shift: "休み")
          .where.not(shift: "内勤")
          .where.not(shift: "帯同")
          .where.not(shift: "欠勤").length 
        %>
        <% 
          new_shift_digestion = 
            r_user.where(shift: "キャッシュレス新規")
            .or(r_user.where(shift: "フェムト新規"))
            .or(r_user.where(shift: "サミット")).length
        %>
        <% slmt_shift_digestion = r_user.where(shift: "キャッシュレス決済").length %>
      <%# 基準値 %>
      
        <% sum_total_visit = r_user.where(shift: "キャッシュレス新規").sum("first_total_visit + latter_total_visit").to_f %>
        <% sum_visit = r_user.where(shift: "キャッシュレス新規").sum("first_visit + latter_visit").to_f %>
        <% sum_interview = r_user.where(shift: "キャッシュレス新規").sum("first_interview + latter_interview").to_f %>
        <% sum_full_talk = r_user.where(shift: "キャッシュレス新規").sum("first_full_talk + latter_full_talk").to_f %>
        <% sum_get = r_user.where(shift: "キャッシュレス新規").sum("first_get + latter_get").to_f %>
      <%# 各商材変数（評価売） %>
        <%# dメル（新規） %>
          <% dmer_user = Dmer.includes(:store_prop).where(user_id: r.user_id) %>
          <% 
            dmer_uq = 
              this_period(dmer_user,@cash_result).where(store_prop: {head_store: nil})
          %><%# dメル期間内獲得数 %>
          <% dmer_def =  dmer_def(dmer_uq,@cash_result) %><%# dメル不備 %>
          <% 
            dmer_inc = 
              judge_inc(dmer_user,@cash_result)
              .where(store_prop: {head_store: nil})
              .where.not(industry_status: "NG")
              .where.not(industry_status: "×") 
          %>
          <% 
            dmer_db = 
              share_period(dmer_user,@cash_result).where.not(store_prop: {head_store: nil})
              .where.not(industry_status: "×").where.not(industry_status: "NG").where.not(industry_status: "要確認")
              .where(status: "審査OK")
          %>
          <% 
            dmer_result1 =  
              dmer_user.where(result_point: @month.beginning_of_month..@month.end_of_month)
              .where.not(industry_status: "NG")
              .where.not(industry_status: "×")
              .where.not(industry_status: "要確認")
              .where(status: "審査OK")
          %>
          <% dmer_valuations = dmer_result1.sum(:valuation_new) %>
          <% dmer_result1_len = dmer_result1.length %>
          <% dmer_len = dmer_uq.length  - dmer_def.length + dmer_db.length %>
          <% if dmer_len == 0 %>
          <% dmer_len_ave = 0  %>
          <% else %>
          <% dmer_len_ave = (dmer_len.to_f / new_shift_digestion).round(1) rescue 0 %>
          <% end %>
          <% dmer_len_fin = (dmer_len_ave * new_shift).round() rescue 0 %>
          <%# 過去月決済対象の数 %>
            <% 
              dmer_slmt_tgt_prev = 
                dmer_user.where("settlement_deadline >= ?", @minimum_date_cash)
                .where("? > date", @minimum_date_cash)
                .where(status: "審査OK")
                .where.not(industry_status: "×")
                .where.not(industry_status: "NG")
                .where.not(industry_status: "要確認")
                .where(status_update_settlement: nil)
                .or(
                  dmer_user.where("settlement_deadline >= ?", @minimum_date_cash)
                  .where("? > date", @minimum_date_cash)
                  .where(status: "審査OK")
                  .where(status_settlement: "完了")
                  .where.not(industry_status: "×")
                  .where.not(industry_status: "NG")
                  .where.not(industry_status: "要確認")
                  .where(status_update_settlement: @month.beginning_of_month..@month.end_of_month)
                )
                dmer_slmt_tgt_prev_len = dmer_slmt_tgt_prev.length rescue 0

            %>
            <%# 決済期限切れ %>
            <% 
              dmer_slmt_dead = 
                dmer_slmt_tgt_prev.where(status_settlement: "期限切れ")
                .where(status_update_settlement: nil) 
            %>
            <% dmer_slmt_dead_len = dmer_slmt_dead.length %>
            <%# 過去の決済対象で今月成果になったもの %>
            <% 
              dmer_slmt_prev_val =  
                dmer_slmt_tgt_prev.where(status_update_settlement: @month.beginning_of_month..@month.end_of_month)
            %>
            <%
              dmer_2ndslmt_prev_val = 
                dmer_slmt_prev_val.where("? >= settlement_second", @month.end_of_month)
            %>
            <% dmer_slmt_prev_val_len = dmer_slmt_prev_val.length %>
            <% dmer_2ndslmt_prev_val_len = dmer_2ndslmt_prev_val.length %>
          <%# 第一成果終着 %>
            <%# 終着獲得数 %>
            <% 
              dmer_val1_period =  
                dmer_user.where(status: "審査OK")
                .where.not(industry_status: "×")
                .where.not(industry_status: "NG")
                .where.not(industry_status: "要確認")
                .where(date: @minimum_date_cash..@maximum_date_cash)
            %>
            <%
              dmer_val2_period = 
                dmer_val1_period.where.not(status_update_settlement: nil).where(status_settlement: "完了")
            %>
            <%
              dmer_val3_period = dmer_val2_period.where.not(settlement_second: nil)
            %>
            <% dmer_val1_period_len = dmer_val1_period.length %>
            <% dmer_val2_period_len = dmer_val2_period.length %>
            <% dmer_val3_period_len = dmer_val3_period.length %>
            <% dmer_result1_fin_len = (dmer_len_ave * new_shift).round() %>
            <%# 期間内終着 %>


            <%
              dmer_result1_fin_this_month_len = 
                (
                  (dmer_len - dmer_val1_period_len).to_f / new_shift_digestion * new_shift * dmer_result1_per
                ).round() rescue 0 
            %>
            <%
              dmer_result1_fin_this_month =
                (dmer_price_1 * dmer_result1_fin_this_month_len) + 
                dmer_result1.where(date: @minimum_date_cash..@maximum_date_cash).sum(:valuation_new)
            %>
            <%# 過去月終着 %>
            <%
              dmer_result1_fin_prev_month_len =
                (
                  (dmer_slmt_tgt_prev.length - dmer_slmt_prev_val_len).to_f * dmer_result1_per_prev
                ).round()
            %>
            <%
              dmer_result1_fin_prev_month = 
                (dmer_price_1 * dmer_result1_fin_prev_month_len) + 
                dmer_result1.where("? > date",@minimum_date_cash).sum(:valuation_new)
            %>
            <% dmer_result1_fin = dmer_result1_fin_this_month + dmer_result1_fin_prev_month %>
        <%# dメル（決済） %>
          <% dmer_slmter = Dmer.where(settlementer_id: r.user_id) %>
          <% 
            dmer_slmt = 
              slmt_period(dmer_slmter ,@cash_result)
              .where.not(industry_status: "×")
              .where.not(industry_status: "NG")
              .where.not(industry_status: "要確認")
              .or(slmt_period(dmer_slmter, @cash_result)
              .where(industry_status: ""))
          %>
          <% dmer_result2 =               
              dmer_slmter.where(status_update_settlement: @month.beginning_of_month..@month.end_of_month)
              .where.not(industry_status: "NG")
              .where.not(industry_status: "×")
              .where.not(industry_status: "要確認")
              .where(status: "審査OK")
              .where(status_settlement: "完了")
          %>

          <% dmer_slmt_valuations = dmer_result2.sum(:valuation_settlement) %>
          <% dmer_result2_len = dmer_result2.length %>
          <% dmer_slmt_len = dmer_slmt.length %>
          <% dmer_slmt2nd = slmt_second(dmer_slmter,@cash_result) %>
          <%# 第二成果終着 %>
            <%# 期間内 %>
            <% 
              dmer_result2_fin_this_month_len =
                (
                  (dmer_len - dmer_val2_period_len).to_f / new_shift_digestion * new_shift * dmer_result2_per
                ).round() rescue 0
            %>
            <%
              dmer_result2_fin_this_month = 
                (dmer_price_2 * dmer_result2_fin_this_month_len) + 
                dmer_result2.where(date: @minimum_date_cash..@maximum_date_cash).sum(:valuation_settlement)
            %>
            <%# 過去月 %>
            <%
              dmer_result2_fin_prev_month = 
                (dmer_price_2 * dmer_result1_fin_prev_month_len) + 
                dmer_result2.where("? > date",@minimum_date_cash).sum(:valuation_settlement)
            %>
            <% dmer_result2_fin = dmer_result2_fin_this_month + dmer_result2_fin_prev_month %>
          <% dmer_result3 = 
              dmer_slmter.where(settlement_second: @month.beginning_of_month..@month.end_of_month)
              .where.not(industry_status: "NG")
              .where.not(industry_status: "×")
              .where.not(industry_status: "要確認")
              .where(status: "審査OK")
              .where(status_settlement: "完了")
              .where("? >= status_update_settlement", @month.end_of_month)
              .or(
                dmer_slmter
                .where.not(industry_status: "NG")
                .where.not(industry_status: "×")
                .where.not(industry_status: "要確認")
                .where(status: "審査OK")
                .where(status_settlement: "完了")
                .where(status_update_settlement: @month.beginning_of_month..@month.end_of_month)
                .where("? >= settlement_second", @month.end_of_month)
              )
          %>
          <% dmer_slmt2nd_valuations = dmer_result3.sum(:valuation_second_settlement) %>
          <% dmer_result3_len = dmer_result3.length %>
          <% dmer_slmt2nd_len = dmer_slmt2nd.length %>
          <%# 第三成果終着 %>
            <%# 期間内 %>
            <% 
              dmer_result3_fin_this_month_len = 
                (
                  (dmer_len - dmer_val3_period_len).to_f / 
                  new_shift_digestion * new_shift * dmer_result3_per
                ).round() rescue 0 
            %>
            <% 
              dmer_result3_fin_this_month = 
              (dmer_price_3 * dmer_result3_fin_this_month_len) + 
              dmer_result3.where(date: @minimum_date_cash..@maximum_date_cash)
              .sum(:valuation_second_settlement)  
            %>
            <%# 過去月 %>
            <% 
              dmer_result3_fin_prev_month = 
              (
                dmer_price_3 * (dmer_slmt_tgt_prev_len - dmer_2ndslmt_prev_val_len - dmer_slmt_dead_len)
              ) + (dmer_result3.where("? > date",@minimum_date_cash).sum(:valuation_second_settlement))
            %>
            <% dmer_result3_fin = dmer_result3_fin_this_month + dmer_result3_fin_prev_month %>
        <%# dメル終着見込獲得数 %>
          <% dmer_val_len = dmer_uq.length - dmer_def.length %><%# 成果件数 %>
          <% dmer_val_len_ave = (dmer_val_len.to_f / new_shift_digestion).round(1) rescue 0 %><%# 生産性 %>
          <% dmer_val_len_fin = dmer_val_len_ave * new_shift %><%# 獲得終着見込 %>
          <% dmer_result1_this_month_fin = dmer_val_len_fin %>
        <%# aupay（新規） %>
          <% aupay_user = Aupay.includes(:store_prop).where(user_id: r.user_id) %>
          <% 
            aupay_uq = 
              this_period(aupay_user,@cash_result).where(store_prop: {head_store: nil})
          %>
          <% aupay_def =  aupay_def(aupay_uq,@cash_result) %>
          <% aupay_inc = judge_inc(aupay_user,@cash_result)  %>
          <% aupay_judge_dec = judge_dec(aupay_user,@cash_result)  %>
          <% aupay_db = 
            result_period(aupay_user,@cash_result)
            .where.not(store_prop: {head_store: nil})
            .where(status: "審査通過") 
          %>
          <%# 合計 %>
          <% 
            aupay_valuations = 0
          %>
          <% 
            aupay_len = 
              aupay_uq.length - aupay_def.length + aupay_db.length
          %>
          <% if aupay_len == 0 %>
          <% aupay_len_ave = 0 %>
          <% else %>
          <% aupay_len_ave = (aupay_len.to_f / new_shift_digestion).round(1) rescue 0 %>
          <% end %>
          <% aupay_len_fin = (aupay_len_ave * new_shift).round() rescue 0 %>

        <%# aupay（決済） %>
          <% aupay_slmt_user = Aupay.where(settlementer_id: r.user_id) %>
          <% aupay_slmt = slmt_period(aupay_slmt_user ,@cash_result) %>
          <% 
            aupay_result1 = 
              aupay_slmt_user.where(status_update_settlement: @month.beginning_of_month..@month.end_of_month)
              .where(status: "審査通過")
              .where(status_settlement: "完了")
          %>
          <% aupay_slmt_valuations = aupay_result1.sum(:valuation_settlement) %>
          <% aupay_result1_len = aupay_result1.length %>
          <% aupay_slmt_len = aupay_slmt.length %>
          <%# 過去月決済対象の数 %>
            <% 
              aupay_slmt_tgt_prev = 
                aupay_user.where("settlement_deadline >= ?", @minimum_date_cash)
                .where("? > date", @minimum_date_cash)
                .where(status: "審査通過")
                .where(status_update_settlement: nil)
                .or(
                  aupay_user.where("settlement_deadline >= ?", @minimum_date_cash)
                  .where("? > date", @minimum_date_cash)
                  .where(status: "審査通過")
                  .where(status_update_settlement: @month.beginning_of_month..@month.end_of_month)
                )
            %>
            <%
              aupay_slmt_prev_val = 
              aupay_slmt_tgt_prev.where(status_update_settlement: @month.beginning_of_month..@month.end_of_month)
            %>
            <% aupay_slmt_prev_val_len = aupay_slmt_prev_val.length %>
            <% 
              aupay_uq_26_10 = 
                Aupay.where(user_id: r.user_id)
                .where(date: @minimum_date_cash..@month.beginning_of_month.since(9.days)) 
            %>
            <%
              aupay_val_26_10 = 
                aupay_uq_26_10.where(status: "審査通過")
                .where(status_settlement: "完了")
                .where(status_update_settlement: @month.beginning_of_month..@month.end_of_month)
            %>
            <%
              aupay_def_26_10 = 
                aupay_uq_26_10.where(status: "不合格")
                .or(aupay_uq_26_10.where(status: "申込取消"))
                .or(aupay_uq_26_10.where(status: "差し戻し"))
                .or(aupay_uq_26_10.where(status: "報酬対象外"))
                .or(aupay_uq_26_10.where(status: "重複対象外"))
                .or(aupay_uq_26_10.where(status: "本店審査待ち"))
                .or(aupay_uq_26_10.where(status: "自社NG"))
                .or(aupay_uq_26_10.where(status: "自社不備"))
            %>
            <% aupay_slmt_tgt_prev_len = aupay_slmt_tgt_prev.length %>
            <% aupay_uq_26_10_len = aupay_uq_26_10.length %>
            <% aupay_val_26_10_len = aupay_val_26_10.length %>
            <% aupay_def_26_10_len = aupay_def_26_10.length %>
        <%# 第一成果終着 %>
          <%# 期間内 %>
          <% 
            aupay_result1_fin_len = 
              (
                (aupay_uq_26_10_len - aupay_def_26_10_len - aupay_val_26_10_len).to_f / 
                new_shift_digestion * new_shift * aupay_slmt_per
              ).round() rescue 0 
          %>
          <%
            aupay_result1_fin_this_month = 
              (aupay_price * aupay_result1_fin_len) + 
              aupay_result1.where(date: @minimum_date_cash..@maximum_date_cash)
              .sum(:valuation_settlement) rescue 0
          %>
          <%# 過去月 %>
          <%
            aupay_result1_fin_prev_month_len = 
              (
                (aupay_slmt_tgt_prev_len - aupay_slmt_prev_val_len) * aupay_slmt_per_prev
              ).round() rescue 0
          %>
          <%
            aupay_result1_fin_prev_month = 
              (aupay_price * aupay_result1_fin_prev_month_len) + 
              aupay_result1.where("? > date",@minimum_date_cash)
              .sum(:valuation_settlement) rescue 0
          %>
          <% aupay_result1_fin = aupay_result1_fin_this_month + aupay_result1_fin_prev_month %>
        <%# auPay写真 %>
          <% 
            aupay_pic = 
              OtherProduct.where(user_id: r.user_id)
              .where(product_name: "auPay写真")
              .where(date: @minimum_date_cash..@maximum_date_cash)
          %>
          <% aupay_pic_val = aupay_pic.sum(:valuation) %>
        <%# /auPay写真 %>
        <%# PayPay %>
          <% paypay_user = Paypay.where(user_id: r.user_id) %>
          <% paypay_data = this_period(paypay_user ,@cash_result) %>
          <% paypay_result = result_period(paypay_user ,@cash_result) %>
          <% 
            paypay_result1 = 
              paypay_user.where(result_point: @month.beginning_of_month..@month.end_of_month)
          %>
          <% paypay_valuations = paypay_result1.sum(:valuation) %>
          <% paypay_result1_len = paypay_result1.length %>
          <% paypay_len = paypay_data.length %>
          <% if paypay_len == 0 %>
          <% paypay_len_ave = 0 %>
          <% else %>
          <% paypay_len_ave = (paypay_len.to_f / new_shift_digestion).round(1) rescue 0 %>
          <% end %>
          <% paypay_fin_len = (paypay_len_ave * new_shift).round() rescue 0 %>
        <%# 第一成果終着 %>
          <% paypay_result1_fin = paypay_price * paypay_fin_len rescue 0 %>
          <% if (paypay_valuations > paypay_result1_fin) || (Date.today >=@month.end_of_month) %>
          <% paypay_result1_fin = paypay_valuations %>
          <% end %>
        <%# 楽天ペイ %>
          <% rakuten_pay_user = RakutenPay.includes(:store_prop).where(user_id: r.user_id) %>
          <% 
            rakuten_pay_uq = 
              this_period(rakuten_pay_user,@cash_result)
          %>
          <% 
            rakuten_pay_dec = 
              rakuten_pay_uq.where.not(deficiency: nil)
              .where.not(share: @minimum_date_cash..@maximum_date_cash)
          %>
          <% 
            rakuten_pay_def =  
              rakuten_pay_uq.where(status: "自社不備")
              .or(rakuten_pay_uq.where(status: "自社NG")) %>
          <% rakuten_pay_inc = rakuten_inc(rakuten_pay_user,@cash_result)  %>
          
          <%# 合計 %>
            <% 
              rakuten_pay_valuations =
                rakuten_pay_uq.sum(:valuation) - 
                rakuten_pay_def.sum(:valuation) -
                rakuten_pay_dec.sum(:valuation) +
                rakuten_pay_inc.sum(:valuation)
            %>
            <% 
              rakuten_pay_len = 
                rakuten_pay_uq.length - 
                rakuten_pay_def.length -
                rakuten_pay_dec.length +
                rakuten_pay_inc.length
            %>
          <% if rakuten_pay_len == 0 %>
          <% rakuten_pay_len_ave = 0 %>
          <% else %>
          <% rakuten_pay_len_ave = (rakuten_pay_len.to_f / new_shift_digestion).round(1) rescue 0 %>
          <% end %>
          <% rakuten_pay_len_fin = (rakuten_pay_len_ave * new_shift).round() rescue 0 %>
          <%# 第一成果 %>
          <% rakuten_pay_result1_fin_len = (rakuten_pay_len_ave * new_shift * 0.9).round() %>
          <% rakuten_pay_result1_fin = rakuten_pay_price * rakuten_pay_result1_fin_len rescue 0 %>
          <% if (rakuten_pay_valuations > rakuten_pay_result1_fin) || (Date.today >= @month.end_of_month) %>
          <% rakuten_pay_result1_fin = rakuten_pay_valuations %>
          <% end %>
        <%# AirPay %>
          <% airpay_user = Airpay.where(user_id: r.user_id) %>
          <% 
            airpay_data = this_period(airpay_user ,@cash_result)
          %>
          <% airpay_result = airpay_data.where(status: "審査完了").or(airpay_data.where(status: "審査中"))
          %>
          <% airpay_len = airpay_result.length %>
          <% if airpay_len == 0 %>
          <% airpay_len_ave = 0 %>
          <% else %>
          <% 
            airpay_len_ave = 
              (airpay_len.to_f / new_shift_digestion).round(1) rescue 0 
          %>
          <% end %>
          <% airpay_len_fin = (airpay_len_ave * new_shift).round() rescue 0 %>
          <% airpay_result1_len = airpay_user.where(result_point: @month.beginning_of_month..@month.end_of_month).where(status: "審査完了").length %>
          <% 
            airpay_valuations = 
              if airpay_result1_len >= 20
                airpay_user
                .where(result_point: @month.beginning_of_month..@month.end_of_month).where(status: "審査完了").sum(:valuation) + (airpay_result1_len * 3000)
              elsif airpay_result1_len >= 10
                airpay_user
                .where(result_point: @month.beginning_of_month..@month.end_of_month).where(status: "審査完了").sum(:valuation) + (airpay_result1_len * 2000)
              else  
                airpay_user.where(result_point: @month.beginning_of_month..@month.end_of_month).where(status: "審査完了").sum(:valuation)
              end
          %>
          <% airpay_result_len_fin = (airpay_len_ave * new_shift * 0.85).round() rescue 0 %>
          <% if airpay_result_len_fin >= 20 %>
            <% airpay_price = 6000 %>
          <% elsif airpay_result_len_fin >= 10 %>
            <% airpay_price = 5000 %>
          <% else %>
            <% airpay_price = 3000 %>
          <% end %>
          <%# 第一成果終着 %>
          <% airpay_result1_fin = airpay_price * airpay_result_len_fin rescue 0 %>
          <% if (airpay_valuations > airpay_result1_fin) || (Date.today >= @month.end_of_month) %>
          <% airpay_result1_fin = airpay_valuations %>
          <% end %>
        <%# 少額短期保険 %>
          <% st_insurance_user = StInsurance.includes(:store_prop).where(user_id: r.user_id) %>
          <% st_insurance_data = this_period(st_insurance_user,@cash_result) %>
          <% st_insurance_valuations = st_insurance_data.sum(:valuation) %>
          <% st_insurance_len = st_insurance_data.length %>
        <%# 楽天フェムト（新規） %>
        <%# 楽天フェムト（設置） %>
        <%# 現状売上 %>
          <% 
            sum_valuations = 
              dmer_valuations +
              dmer_slmt_valuations +
              dmer_slmt2nd_valuations +
              aupay_valuations + 
              aupay_slmt_valuations +
              paypay_valuations +
              rakuten_pay_valuations + 
              st_insurance_valuations +
              airpay_valuations + 
              aupay_pic_val
          %>
          <% 
            sum_valuations_fin = 
              (
                dmer_result1_fin +
                dmer_result2_fin  +
                dmer_result3_fin +
                aupay_result1_fin +
                paypay_result1_fin +
                rakuten_pay_result1_fin +
                airpay_result1_fin +
                aupay_pic_val
              ).to_i
           %>

           <% if (sum_valuations > sum_valuations_fin) || Date.today > @month.end_of_month %>
            <% sum_valuations_fin = sum_valuations rescue 0 %>
           <% end %>
           <% sum_valuations_ave = 0 %>
          <% if  (sum_valuations_fin.present?) && (shifts != 0) %>
            <% sum_valuations_ave = sum_valuations_fin / shifts rescue 0 %>
          <% end %>
          <%# 各訪問員のデータをハッシュに格納 %>
          <% ranking.store(r.user.name,[sum_valuations_fin]) %>
          <% ranking_ave.store(r.user.name,[sum_valuations_ave]) %>
          <%# 合計獲得数 %>
          <% sum_product = (dmer_uq.length + aupay_uq.length + rakuten_pay_uq.length + airpay_data.length).to_f %>
          <% base_sum_product += sum_product %>
          <% base_dmer += dmer_len %>
          <% base_dmer_ave = base_dmer / shift_digestion rescue 0 %>
          <% base_dmer_fin += dmer_len_fin %>
          <% base_dmer_slmt += dmer_slmt_len %>
          <% base_dmer_slmt2nd += dmer_slmt2nd_len %>
          <% base_aupay += aupay_len %>
          <% base_aupay_ave = base_aupay / shift_digestion rescue 0 %>
          <% base_aupay_fin += aupay_len_fin %>
          <% base_aupay_slmt += aupay_slmt_len %>
          <% base_paypay += paypay_len %>
          <% base_paypay_ave = base_paypay / shift_digestion rescue 0 %>
          <% base_paypay_fin += paypay_fin_len %>
          <% base_rakuten_pay += rakuten_pay_len %>
          <% base_rakuten_pay_ave = base_rakuten_pay / shift_digestion rescue 0 %>
          <% base_rakuten_pay_fin += rakuten_pay_len_fin %>
          <% base_airpay += airpay_len %>
          <% base_airpay_ave = base_airpay / shift_digestion rescue 0 %>
          <% base_airpay_fin += airpay_len_fin %>
          <% base_st_insurace += st_insurance_len %>
          <% base_sum += sum_valuations %>
          <% base_fin += sum_valuations_fin %>
          <%# 成果件数 %>
          <% base_dmer_result1_len += dmer_result1_len %>
          <% base_dmer_result2_len += dmer_result2_len %>
          <% base_dmer_result3_len += dmer_result3_len %>
          <% base_aupay_result1_len += aupay_result1_len %>
          <% base_paypay_result1_len += paypay_result1_len %>
          <% base_airpay_result1_len += airpay_result1_len %>
      <% end %>
  <% end %>
<% end %>
    <% ranking = ranking.sort {|(k1,v1), (k2,v2)| v2<=>v1}.to_h %>
    <% ranking_ave = ranking_ave.sort {|(k1,v1), (k2,v2)| v2<=>v1}.to_h %>
    <div style="display: flex;">
      <div><%# 終着 %>
        <p class="sub-title">終着</p>
        <table>
          <thead>
            <tr>
              <th class="rank-th">順位</th>
              <th class="rank-th">氏名</th>
              <th class="rank-th">終着売上</th>
            </tr>
          </thead>
          <tbody>
          <% ranking.each_with_index do |rank,i| %>
            <tr>
              <td class="rank-td"><%= i + 1 %>位</td>
              <td class="rank-td"><%= rank[0] %></td>
              <td class="rank-td"><%= (rank[1][0]).to_s(:delimited) %></td>
            </tr>
          <% break if i == 4 %>
          <% end %>
          </tbody>
        </table>
      </div><%# /終着 %>
      <div><%# Ave %>
        <p class="sub-title">平均</p>
        <table>
          <thead>
            <tr>
              <th class="rank-th">順位</th>
              <th class="rank-th">氏名</th>
              <th class="rank-th">Ave</th>
            </tr>
          </thead>
          <tbody>
          <% ranking_ave.each_with_index do |rank,i| %>
            <tr>
              <td class="rank-td"><%= i + 1 %>位</td>
              <td class="rank-td"><%= rank[0] %></td>
              <td class="rank-td"><%= (rank[1][0]).to_s(:delimited) %></td>
            </tr>
          <% break if i == 4 %>
          <% end %>
          </tbody>
        </table>
      </div><%# /終着 %>
    </div>
    <h2>商材別獲得数</h2>
    <div style="display: flex;">
      <div><%# dメル %>
        <p class="sub-title">dメル</p>
        <table>
          <thead>
            <tr>
              <th>順位</th>
              <th>氏名</th>
              <th>現状獲得数</th>
            </tr>
          </thead>
          <tbody>
          <% @dmers_rank.each_with_index do |dmer,i| %>
            <tr>
              <td><%= i + 1 %>位</td>
              <td><%= dmer[0] %></td>
              <td><%= (dmer[1]) %></td>
            </tr>
          <% break if i == 4 %>
          <% end %>
          </tbody>
        </table>
      </div><%# /dメル %>
      <div><%# auPay %>
        <p class="sub-title">auPay</p>
        <table>
          <thead>
            <tr>
              <th>順位</th>
              <th>氏名</th>
              <th>現状獲得数</th>
            </tr>
          </thead>
          <tbody>
          <% @aupays_rank.each_with_index do |aupay,i| %>
            <tr>
              <td><%= i + 1 %>位</td>
              <td><%= aupay[0] %></td>
              <td><%= (aupay[1]) %></td>
            </tr>
          <% break if i == 4 %>
          <% end %>
          </tbody>
        </table>
      </div><%# /auPay %>
    </div>
    <div style="display: flex;">
      <div><%# 楽天ペイ %>
        <p class="sub-title">楽天ペイ</p>
        <table>
          <thead>
            <tr>
              <th>順位</th>
              <th>氏名</th>
              <th>現状獲得数</th>
            </tr>
          </thead>
          <tbody>
          <% @rakuten_pays_rank.each_with_index do |rakuten_pay,i| %>
            <tr>
              <td><%= i + 1 %>位</td>
              <td><%= rakuten_pay[0] %></td>
              <td><%= (rakuten_pay[1]) %></td>
            </tr>
          <% break if i == 4 %>
          <% end %>
          </tbody>
        </table>
      </div><%# /楽天ペイ %>
      <div><%# AirPay %>
        <p class="sub-title">AirPay</p>
        <table>
          <thead>
            <tr>
              <th>順位</th>
              <th>氏名</th>
              <th>現状獲得数</th>
            </tr>
          </thead>
          <tbody>
          <% @airpays_rank.each_with_index do |airpay,i| %>
            <tr>
              <td><%= i + 1 %>位</td>
              <td><%= airpay[0] %></td>
              <td><%= (airpay[1]) %></td>
            </tr>
          <% break if i == 4 %>
          <% end %>
          </tbody>
        </table>
      </div><%# /AirPay %>
    </div>
      <p class="caution-text">※獲得数は不備・NGも入ってます。（<%= @minimum_date_cash.strftime("%m月%d日") %>〜<%= @maximum_date_cash.strftime("%m月%d日") %>）の範囲で算出しております。</p>
  </div>
</div>